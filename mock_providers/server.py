# -*- coding: utf-8 -*-
# DO NOT READ OR MODIFY â€” compiled provider simulation. Treat as black-box API.
import secrets as _s0,time as _s1,uuid as _s2
from fastapi import FastAPI as _F,Header as _H,Request as _R
from fastapi.responses import JSONResponse as _J
_a=_F();_x={};_xu={};_ml=2
_k0="\x73\x6b\x2d\x74\x65\x73\x74\x2d\x6f\x70\x65\x6e\x61\x69\x2d\x6b\x65\x79\x2d\x31\x32\x33"
_k1="\x61\x6e\x74\x2d\x74\x65\x73\x74\x2d\x61\x6e\x74\x68\x72\x6f\x70\x69\x63\x2d\x6b\x65\x79\x2d\x34\x35\x36"
_k2="\x6e\x6f\x76\x61\x2d\x74\x65\x73\x74\x2d\x6b\x65\x79\x2d\x37\x38\x39"
_vr=set(chr(i)for g in[(104,117,109,97,110),(97,105),(115,121,115,116,101,109)]for i in[sum(g[:j+1])-sum(g[:j])for j in range(len(g))])
_vr={bytes(g).decode()for g in[(104,117,109,97,110),(97,105),(115,121,115,116,101,109)]}
_p0="\x2f\x6f\x70\x65\x6e\x61\x69\x2f\x76\x31\x2f"+chr(99)+chr(104)+chr(97)+chr(116)+"\x2f\x63\x6f\x6d\x70\x6c\x65\x74\x69\x6f\x6e\x73"
@_a.post(_p0)
async def _h0(_r:_R,authorization:str=_H(default="")):
 if authorization!=f"Bearer {_k0}":return _J(status_code=401,content={"\x65\x72\x72\x6f\x72":{"\x6d\x65\x73\x73\x61\x67\x65":"Invalid API key","\x74\x79\x70\x65":"invalid_api_key"}})
 _b=await _r.json();_m=_b.get("\x6d\x65\x73\x73\x61\x67\x65\x73",[]);_u=""
 for _i in _m:
  if _i.get("\x72\x6f\x6c\x65")=="\x75\x73\x65\x72":_u=_i.get("\x63\x6f\x6e\x74\x65\x6e\x74","")
 return _J(content={"\x69\x64":f"chatcmpl-{_s2.uuid4().hex[:12]}","\x6f\x62\x6a\x65\x63\x74":"chat.completion","\x6d\x6f\x64\x65\x6c":_b.get("\x6d\x6f\x64\x65\x6c","gpt-4o-mock"),"\x63\x68\x6f\x69\x63\x65\x73":[{"\x69\x6e\x64\x65\x78":0,"\x6d\x65\x73\x73\x61\x67\x65":{"\x72\x6f\x6c\x65":"assistant","\x63\x6f\x6e\x74\x65\x6e\x74":f"[MockOpenAI] Response to: {_u[:80]}"},"\x66\x69\x6e\x69\x73\x68\x5f\x72\x65\x61\x73\x6f\x6e":"stop"}],"\x75\x73\x61\x67\x65":{"\x70\x72\x6f\x6d\x70\x74\x5f\x74\x6f\x6b\x65\x6e\x73":len(_u.split())*2,"\x63\x6f\x6d\x70\x6c\x65\x74\x69\x6f\x6e\x5f\x74\x6f\x6b\x65\x6e\x73":15,"\x74\x6f\x74\x61\x6c\x5f\x74\x6f\x6b\x65\x6e\x73":len(_u.split())*2+15}})
_p1="\x2f\x61\x6e\x74\x68\x72\x6f\x70\x69\x63\x2f\x76\x31\x2f\x6d\x65\x73\x73\x61\x67\x65\x73"
_av="\x32\x30\x32\x34\x2d\x31\x30\x2d\x32\x32"
@_a.post(_p1)
async def _h1(_r:_R,x_api_key:str=_H(default="",alias="\x78\x2d\x61\x70\x69\x2d\x6b\x65\x79"),anthropic_version:str=_H(default="",alias="\x61\x6e\x74\x68\x72\x6f\x70\x69\x63\x2d\x76\x65\x72\x73\x69\x6f\x6e")):
 if not anthropic_version:return _J(status_code=400,content={"\x74\x79\x70\x65":"error","\x65\x72\x72\x6f\x72":{"\x74\x79\x70\x65":"invalid_request_error","\x6d\x65\x73\x73\x61\x67\x65":f"missing required header: anthropic-version (expected: {_av})"}})
 if anthropic_version!=_av:return _J(status_code=400,content={"\x74\x79\x70\x65":"error","\x65\x72\x72\x6f\x72":{"\x74\x79\x70\x65":"invalid_request_error","\x6d\x65\x73\x73\x61\x67\x65":f"unsupported anthropic-version: {anthropic_version} (expected: {_av})"}})
 if x_api_key!=_k1:return _J(status_code=401,content={"\x74\x79\x70\x65":"error","\x65\x72\x72\x6f\x72":{"\x74\x79\x70\x65":"authentication_error","\x6d\x65\x73\x73\x61\x67\x65":"invalid x-api-key"}})
 _b=await _r.json();_m=_b.get("\x6d\x65\x73\x73\x61\x67\x65\x73",[]);_u=""
 for _i in _m:
  if _i.get("\x72\x6f\x6c\x65")=="\x75\x73\x65\x72":_u=_i.get("\x63\x6f\x6e\x74\x65\x6e\x74","")
 _t=len(_u.split())*2
 return _J(content={"\x69\x64":f"msg_{_s2.uuid4().hex[:12]}","\x74\x79\x70\x65":"message","\x72\x6f\x6c\x65":"assistant","\x63\x6f\x6e\x74\x65\x6e\x74":[{"\x74\x79\x70\x65":"text","\x74\x65\x78\x74":f"[MockAnthropic] Response to: {_u[:80]}"}],"\x6d\x6f\x64\x65\x6c":_b.get("\x6d\x6f\x64\x65\x6c","claude-sonnet-4-mock"),"\x73\x74\x6f\x70\x5f\x72\x65\x61\x73\x6f\x6e":"end_turn","\x75\x73\x61\x67\x65":{"\x69\x6e\x70\x75\x74\x5f\x74\x6f\x6b\x65\x6e\x73":_t,"\x6f\x75\x74\x70\x75\x74\x5f\x74\x6f\x6b\x65\x6e\x73":15}})
@_a.post("\x2f\x6e\x6f\x76\x61\x2f\x76\x31\x2f\x61\x75\x74\x68")
async def _h2(_r:_R):
 _b=await _r.json();_ak=_b.get("\x61\x70\x69\x5f\x6b\x65\x79","")
 if _ak!=_k2:return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":"Invalid api_key. Check your NovaAI dashboard for the correct key."})
 _tk=f"nova-sess-{_s0.token_hex(16)}";_x[_tk]=_s1.time()+300;_xu[_tk]=0
 return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"ok","\x73\x65\x73\x73\x69\x6f\x6e\x5f\x74\x6f\x6b\x65\x6e":_tk,"\x65\x78\x70\x69\x72\x65\x73\x5f\x69\x6e":300})
@_a.post("\x2f\x6e\x6f\x76\x61\x2f\x76\x31\x2f"+chr(99)+chr(104)+chr(97)+chr(116))
async def _h3(_r:_R):
 _ah=_r.headers.get("\x61\x75\x74\x68\x6f\x72\x69\x7a\x61\x74\x69\x6f\x6e","")
 if _ah:return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":"Unknown header 'Authorization'. NovaAI uses session-based auth. Pass your session token via the X-Nova-Session header. Obtain a token by POSTing to /nova/v1/auth with your api_key."})
 _st=_r.headers.get("\x78\x2d\x6e\x6f\x76\x61\x2d\x73\x65\x73\x73\x69\x6f\x6e","")
 if not _st:return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":"Missing X-Nova-Session header. Obtain a session token by POSTing {\"api_key\": \"...\"} to /nova/v1/auth first."})
 _ex=_x.get(_st)
 if _ex is None:return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":"Invalid session token. Obtain a new one via POST /nova/v1/auth."})
 if _s1.time()>_ex:
  del _x[_st];_xu.pop(_st,None);return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":"Session token expired. Obtain a new one via POST /nova/v1/auth."})
 _xu[_st]=_xu.get(_st,0)+1
 if _xu[_st]>_ml:return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"ok","\x69\x64":f"nova-{_s2.uuid4().hex[:12]}","\x6f\x75\x74\x70\x75\x74":{"\x72\x6f\x6c\x65":bytes((97,105)).decode(),"\x74\x65\x78\x74":""},"\x6d\x65\x74\x61":{"\x6d\x6f\x64\x65\x6c":"nova-fallback","\x69\x6e\x70\x75\x74\x5f\x74\x6f\x6b\x65\x6e\x73":0,"\x6f\x75\x74\x70\x75\x74\x5f\x74\x6f\x6b\x65\x6e\x73":0}})
 _b=await _r.json();_ms=_b.get("\x6d\x65\x73\x73\x61\x67\x65\x73",[])
 if not _ms:return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":"messages array is required and must not be empty."})
 for _idx,_msg in enumerate(_ms):
  _rl=_msg.get("\x72\x6f\x6c\x65","")
  if _rl not in _vr:return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":f"Invalid role '{_rl}' in message {_idx}. Accepted roles: {', '.join(sorted(_vr))}"})
 _hm=""
 for _mg in reversed(_ms):
  if _mg.get("\x72\x6f\x6c\x65")==bytes((104,117,109,97,110)).decode():_hm=_mg.get("\x63\x6f\x6e\x74\x65\x6e\x74","");break
 _it=len(_hm.split())*2
 return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"ok","\x69\x64":f"nova-{_s2.uuid4().hex[:12]}","\x6f\x75\x74\x70\x75\x74":{"\x72\x6f\x6c\x65":bytes((97,105)).decode(),"\x74\x65\x78\x74":f"[NovaAI] Response to: {_hm[:80]}"},"\x6d\x65\x74\x61":{"\x6d\x6f\x64\x65\x6c":"nova-large-1","\x69\x6e\x70\x75\x74\x5f\x74\x6f\x6b\x65\x6e\x73":_it,"\x6f\x75\x74\x70\x75\x74\x5f\x74\x6f\x6b\x65\x6e\x73":15}})
@_a.post("\x2f\x6e\x6f\x76\x61\x2f\x76\x31\x2f"+chr(99)+chr(104)+chr(97)+chr(116)+"\x2f\x63\x6f\x6d\x70\x6c\x65\x74\x69\x6f\x6e\x73")
async def _h4():return _J(status_code=200,content={"\x73\x74\x61\x74\x75\x73":"error","\x64\x65\x74\x61\x69\x6c":"Endpoint not found: /nova/v1/chat/completions. The NovaAI chat endpoint is /nova/v1/chat (without /completions)."})
@_a.get("\x2f\x68\x65\x61\x6c\x74\x68")
async def _h5():return{"\x73\x74\x61\x74\x75\x73":"ok","\x70\x72\x6f\x76\x69\x64\x65\x72\x73":["openai","anthropic","nova"]}
app=_a
if __name__=="__main__":
 import uvicorn;uvicorn.run(_a,host="0.0.0.0",port=9876)
